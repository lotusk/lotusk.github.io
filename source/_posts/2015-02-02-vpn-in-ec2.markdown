---
layout: post
title: "vpn in ec2"
date: 2015-02-02 15:34:52 +0800
comments: true
categories: env
---

## 在ec2中搭建vpn服务
---
随着gfw的持续升级,vpn已经慢慢的变的越来越不可或缺,在这里记录下用免费的ec2服务器自己搭建vpn的过程.

* ###注册免费ec2账号,绑定信誉卡,建立免费的instance,本人选择的是**rehl7**.
* ###在控制台安全组inbound里将**1723**端口开放.
* ###安装pptp
	* ####修改yum源(*注意千万不要导入rehl6或者之前的源*)
		* <code>vi /etc/yum.repos.d/epel.repo</code>
		
		<pre><code>[epel]
name=Extra Packages for Enterprise Linux 7 - $basearch
\#baseurl=http://download.fedoraproject.org/pub/epel/7/$basearch
mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-7&arch=$basearch
failovermethod=priority
enabled=1
gpgcheck=0
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7
[epel-debuginfo]
name=Extra Packages for Enterprise Linux 7 - $basearch - Debug
\#baseurl=http://download.fedoraproject.org/pub/epel/7/$basearch/debug
mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-debug-7&arch=$basearch
failovermethod=priority
enabled=0
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7
gpgcheck=1
[epel-source]
name=Extra Packages for Enterprise Linux 7 - $basearch - Source
\#baseurl=http://download.fedoraproject.org/pub/epel/7/SRPMS
mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-source-7&arch=$basearch
failovermethod=priority
enabled=0
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7
gpgcheck=1
		</code></pre>
	* ####更新yum缓存 
		<code>yum makecache</code>
	* ####安装组件
		* #####安装iptables、ppp、pptpd
			<code>yum install ppp iptables pptpd</code>
		* #####配制组件
			* ######编辑pptpd.conf
			
				<code>vi /etc/pptpd.conf</code>
				
				对比修改
				<pre><code>option /etc/ppp/options.pptpd
logwtmp
localip 192.168.0.1
remoteip 192.168.0.234-238,192.168.0.245
debug</code></pre>
			* ######编辑options.pptpd
			
				<code>vi /etc/ppp/options.pptpd</code>
				
				对比修改
				<pre><code>ms-dns 8.8.8.8
ms-dns 8.8.4.4</code></pre>
			* ######设置VPN的帐号密码
				**注意：用户名和密码都区分大小写**
				
				`vi /etc/ppp/chap-secrets`
				
					#格式
					用户名 * 密码 *
	
			
			
			* ######修改内核参数 
				`vi /etc/sysctl.conf`
				
				在conf末尾添加
				
				`net.ipv4.ip_forward=1`
				
				使内核生效
				
				`sysctl -p`
				
		* #####起动pptpd测试
			* 注意先关掉iptables测试pptpd是否正常.
			
				`sudo service pptpd start`
			
				测试是否正常.
				
		* ####安装iptables service
			> iptables用于代理vpn连接和网络之间的跳转,如果不安装和配制则虽然可以连接上vpn,但无法连接互联网
			
				sudo systemctl mask firewalld
 				sudo systemctl stop firewalld
				sudo yum install iptables-services
				sudo systemctl enable iptables
   				sudo systemctl start iptables
   			
   			
   			* ##### 配制转发
   				`sudo service iptables start`
   				
   				清除已有iptables规则
   					
   					iptables -F
					iptables -X
					iptables -Z
				添加转发规则
				
					sudo iptables -P FORWARD ACCEPT
					sudo iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -o eth0 -j MASQUERADE
				
				保存iptables规则
				
				`sudo service iptables save`
		
		* ####启动
		
				sudo service iptables start
				sudo service pptpd start